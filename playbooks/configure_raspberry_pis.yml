---

- name: Get info from master
  hosts: kubernetes_master
  tasks:
    - name: Get node key
      become: true
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_key

    - set_fact:
        node_key: "{{ node_key.content | b64decode | replace('\n', '') }}"

    - debug:
        var: node_key

- name: Configure raspberry pis
  hosts: raspberry_pi
  become: true
  tasks:
    - name: Enable cgroup
      shell: "grep -q 'cgroup_memory=1 cgroup_enable=memory' /boot/cmdline.txt"
      register: grep_result
      ignore_errors: yes

    - block:
        - ansible.builtin.slurp:
            src: /boot/cmdline.txt
          register: cmdline_file

        - set_fact:
            cmdline_file: "{{ cmdline_file['content'] | b64decode | replace('\n', '')}} cgroup_memory=1 cgroup_enable=memory"
        
        - ansible.builtin.file:
            path: /boot/cmdline.txt
            state: absent

        - ansible.builtin.file:
            path: /boot/cmdline.txt
            state: touch

        - ansible.builtin.lineinfile:
            line: "{{ cmdline_file }}"
            path: /boot/cmdline.txt
      when: grep_result.rc == 1

- name: Configure nodes
  hosts: kubernetes_agents
  become: true
  tasks:
    - name: Remove the agent
      shell: "/usr/local/bin/k3s-agent-uninstall.sh"
      ignore_errors: yes

    - debug:
        msg: "curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars['kube']['ansible_host'] }}:6443 K3S_TOKEN={{ hostvars['kube']['node_key'] }} sh -"

    - name: Initialize the agent
      shell: "curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars['kube']['ansible_host'] }}:6443 K3S_TOKEN={{ hostvars['kube']['node_key'] }} sh -"